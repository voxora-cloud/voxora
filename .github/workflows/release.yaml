name: Build & Push Docker Images

on:
  push:
    tags:
      - "v*"           # triggers on: git tag v0.9.0-beta && git push --tags
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 0.9.0-beta)"
        required: true

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Strip leading 'v' from tag  â†’  v0.9.0-beta becomes 0.9.0-beta
      - name: Resolve version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          fi

      - name: Set up QEMU (for multi-platform builds)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build & push API
        uses: docker/build-push-action@v6
        with:
          context: ./apps/api
          file: ./apps/api/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/voxora-api:${{ steps.version.outputs.tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/voxora-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # â”€â”€ WEB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Built with placeholder values (__NEXT_PUBLIC_API_URL__ etc).
      # entrypoint.sh replaces them at container startup from .env.web â€” 
      # so this is now a generic image that works with any server IP/domain.
      - name: Build & push Web
        uses: docker/build-push-action@v6
        with:
          context: ./apps/web
          file: ./apps/web/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/voxora-web:${{ steps.version.outputs.tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/voxora-web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # â”€â”€ AI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build & push AI worker
        uses: docker/build-push-action@v6
        with:
          context: ./apps/ai
          file: ./apps/ai/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/voxora-ai:${{ steps.version.outputs.tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/voxora-ai:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # â”€â”€ WIDGET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Builds the widget JS bundle and packages it with the deploy script.
      # The widget-deploy service in docker-compose runs this image on startup
      # to push voxora.js into MinIO automatically.
      - name: Build & push Widget
        uses: docker/build-push-action@v6
        with:
          context: ./apps/widget
          file: ./apps/widget/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/voxora-widget:${{ steps.version.outputs.tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/voxora-widget:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Summary
        run: |
          echo "### ðŸš€ Released \`${{ steps.version.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| voxora-api | \`${{ steps.version.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| voxora-web | \`${{ steps.version.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| voxora-ai  | \`${{ steps.version.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| voxora-widget | \`${{ steps.version.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
